<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Christmas Virus</title>
    <meta property="og:description" content="Christmas Virus">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="main.css">
    <!--<link href='https://fonts.googleapis.com/css?family=Lato:400,700,700italic,400italic,300,300italic' rel='stylesheet' type='text/css'>-->
</head>

</script>

<body>
    <!--<h1>Christmas Virus</h1>-->
    <div id="container" ></div>
</body>

<script type="x-shader/x-vertex" id="material-vs" >

varying vec3 vNormal;
varying vec3 vLightPos;
varying vec3 vPosition;
varying vec3 vReflect;

void main() {

	vNormal = normalMatrix * normal;
	
	vec3 lightPos = vec3( 0., 120., 80. );
	vLightPos = ( modelViewMatrix * vec4( lightPos, 1. ) ).xyz;
	
	vec4 mvPosition = modelViewMatrix * vec4( position, 1. );
	vec4 mPosition = modelMatrix * vec4( position, 1. );
	gl_Position = projectionMatrix * mvPosition;
	vPosition = mvPosition.xyz;

	vec3 nWorld = normalize( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );
	vReflect = normalize( reflect( normalize( mPosition.xyz - cameraPosition ), nWorld ) );

}

</script>

<script type="x-shader/x-vertex" id="material-fs" >

uniform sampler2D envMap;
uniform sampler2D blurEnvMap;

varying vec3 vNormal;
varying vec3 vLightPos;
varying vec3 vPosition;
varying vec3 vReflect;

float PI = 3.14159265358979323846264;

vec2 normalToUV( vec3 n ) {

	vec3 normal = normalize( n );
	float lon = atan( normal.z , - normal.x );
	float lat = asin( - normal.y );
	vec2 uv = 0.5 - vec2( lon, lat ) / vec2( PI * 2.0, PI );
    return uv;

}

void main() {

	vec3 ambient = vec3( .1, .1, .1 );
	vec3 n = normalize( vNormal );

	float c = .5 * dot( normalize( vLightPos ), n );

	vec3 r = -reflect( vLightPos, n );
	r = normalize( r );
	vec3 v = -vPosition.xyz;
	v = normalize(v);
	float nDotHV = max( 0., dot( r, v ) );

	float shininess = 100.;
	float specular = 0.;
	if( c != 0. ) specular = pow ( nDotHV, shininess );

	float rim = 1. - max( 0., abs( dot( n, v ) ) );
	rim = smoothstep( .5, 1., rim );

	vec3 diffuse = texture2D( blurEnvMap, normalToUV( vNormal ) ).xyz;
	vec3 ref = texture2D( envMap, normalToUV( vReflect ) ).xyz;

	vec3 color = vec3( c ) + ambient + specular + rim + vec3( .25, 0., 0. ) * ( 1. - clamp( .001 * gl_FragCoord.y, 0., 1. ) );
	color = mix( ambient + c * diffuse + specular, ref, .05 + .95 * rim );
	//color = vec3( rim );
	//color = ref;

	gl_FragColor = vec4( color, 1. );

}

</script>

<script src="libs/three.min.js"></script>
<script src="libs/OrbitControls.js"></script>
<script src="libs/OBJLoader.js"></script>
<script src="libs/Maf.js"></script>

<script src="main-base.js"></script>

</html>